<svg width="1200" height="800" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .table-box { fill: #f8f9fa; stroke: #343a40; stroke-width: 2; }
      .table-header { fill: #007bff; }
      .table-title { fill: white; font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; }
      .field-text { fill: #343a40; font-family: Arial, sans-serif; font-size: 11px; }
      .pk-field { fill: #dc3545; font-weight: bold; }
      .fk-field { fill: #28a745; }
      .relationship-line { stroke: #6c757d; stroke-width: 2; fill: none; }
      .relationship-arrow { fill: #6c757d; }
    </style>
  </defs>

  <!-- Title -->
  <text x="600" y="30" text-anchor="middle" class="table-title" font-size="18">PMS Database ERD - Post Schema Cleanup & Index Audit</text>

  <!-- Auth Tokens Table -->
  <g id="auth_tokens">
    <rect x="50" y="60" width="200" height="180" class="table-box"/>
    <rect x="50" y="60" width="200" height="25" class="table-header"/>
    <text x="150" y="78" text-anchor="middle" class="table-title">auth_tokens</text>
    <text x="60" y="100" class="field-text pk-field">id (UUID) PK</text>
    <text x="60" y="115" class="field-text">token_hash (VARCHAR)</text>
    <text x="60" y="130" class="field-text">user_id (UUID)</text>
    <text x="60" y="145" class="field-text">token_type (VARCHAR)</text>
    <text x="60" y="160" class="field-text">status (VARCHAR)</text>
    <text x="60" y="175" class="field-text">expires_at (TIMESTAMP)</text>
    <text x="60" y="190" class="field-text">rotation_count (INTEGER)</text>
    <text x="60" y="205" class="field-text fk-field">parent_token_id (UUID) FK</text>
    <text x="60" y="220" class="field-text">tenant_id (UUID)</text>
  </g>

  <!-- Encryption Keys Table -->
  <g id="encryption_keys">
    <rect x="300" y="60" width="220" height="200" class="table-box"/>
    <rect x="300" y="60" width="220" height="25" class="table-header"/>
    <text x="410" y="78" text-anchor="middle" class="table-title">encryption_keys</text>
    <text x="310" y="100" class="field-text pk-field">id (UUID) PK</text>
    <text x="310" y="115" class="field-text">key_name (VARCHAR)</text>
    <text x="310" y="130" class="field-text">kms_key_id (VARCHAR)</text>
    <text x="310" y="145" class="field-text">version (INTEGER)</text>
    <text x="310" y="160" class="field-text">status (VARCHAR)</text>
    <text x="310" y="175" class="field-text">key_type (VARCHAR)</text>
    <text x="310" y="190" class="field-text fk-field">parent_key_id (UUID) FK</text>
    <text x="310" y="205" class="field-text fk-field">created_by_token_id (UUID) FK</text>
    <text x="310" y="220" class="field-text fk-field">rotated_by_token_id (UUID) FK</text>
    <text x="310" y="235" class="field-text fk-field">rotation_policy_id (UUID) FK</text>
    <text x="310" y="250" class="field-text">tenant_id (UUID)</text>
  </g>

  <!-- Key Rotation Policies Table -->
  <g id="key_rotation_policies">
    <rect x="570" y="60" width="220" height="160" class="table-box"/>
    <rect x="570" y="60" width="220" height="25" class="table-header"/>
    <text x="680" y="78" text-anchor="middle" class="table-title">key_rotation_policies</text>
    <text x="580" y="100" class="field-text pk-field">id (UUID) PK</text>
    <text x="580" y="115" class="field-text">name (VARCHAR)</text>
    <text x="580" y="130" class="field-text">rotation_interval_days (INTEGER)</text>
    <text x="580" y="145" class="field-text">max_key_age_days (INTEGER)</text>
    <text x="580" y="160" class="field-text">auto_rotate (BOOLEAN)</text>
    <text x="580" y="175" class="field-text">notification_days_before (INTEGER)</text>
    <text x="580" y="190" class="field-text">is_active (BOOLEAN)</text>
    <text x="580" y="205" class="field-text">created_at (TIMESTAMP)</text>
  </g>

  <!-- FHIR Mappings Table -->
  <g id="fhir_mappings">
    <rect x="50" y="300" width="220" height="180" class="table-box"/>
    <rect x="50" y="300" width="220" height="25" class="table-header"/>
    <text x="160" y="318" text-anchor="middle" class="table-title">fhir_mappings</text>
    <text x="60" y="340" class="field-text pk-field">id (UUID) PK</text>
    <text x="60" y="355" class="field-text">internal_id (UUID)</text>
    <text x="60" y="370" class="field-text">fhir_resource_id (VARCHAR)</text>
    <text x="60" y="385" class="field-text">fhir_resource_type (VARCHAR)</text>
    <text x="60" y="400" class="field-text">fhir_server_url (VARCHAR)</text>
    <text x="60" y="415" class="field-text">mapping_version (INTEGER)</text>
    <text x="60" y="430" class="field-text">is_active (BOOLEAN)</text>
    <text x="60" y="445" class="field-text">sync_status (VARCHAR)</text>
    <text x="60" y="460" class="field-text">error_count (INTEGER)</text>
  </g>

  <!-- Practice Profiles Table -->
  <g id="practice_profiles">
    <rect x="320" y="300" width="200" height="180" class="table-box"/>
    <rect x="320" y="300" width="200" height="25" class="table-header"/>
    <text x="420" y="318" text-anchor="middle" class="table-title">practice_profiles</text>
    <text x="330" y="340" class="field-text pk-field">id (UUID) PK</text>
    <text x="330" y="355" class="field-text">name (VARCHAR)</text>
    <text x="330" y="370" class="field-text">npi_number (VARCHAR)</text>
    <text x="330" y="385" class="field-text">tax_id (VARCHAR)</text>
    <text x="330" y="400" class="field-text">email (VARCHAR)</text>
    <text x="330" y="415" class="field-text">phone (VARCHAR)</text>
    <text x="330" y="430" class="field-text">specialty (VARCHAR)</text>
    <text x="330" y="445" class="field-text">is_active (BOOLEAN)</text>
    <text x="330" y="460" class="field-text">tenant_id (UUID)</text>
  </g>

  <!-- Locations Table -->
  <g id="locations">
    <rect x="570" y="300" width="200" height="200" class="table-box"/>
    <rect x="570" y="300" width="200" height="25" class="table-header"/>
    <text x="670" y="318" text-anchor="middle" class="table-title">locations</text>
    <text x="580" y="340" class="field-text pk-field">id (UUID) PK</text>
    <text x="580" y="355" class="field-text fk-field">practice_profile_id (UUID) FK</text>
    <text x="580" y="370" class="field-text">name (VARCHAR)</text>
    <text x="580" y="385" class="field-text">address_line1 (VARCHAR)</text>
    <text x="580" y="400" class="field-text">city (VARCHAR)</text>
    <text x="580" y="415" class="field-text">state (VARCHAR)</text>
    <text x="580" y="430" class="field-text">zip_code (VARCHAR)</text>
    <text x="580" y="445" class="field-text">phone (VARCHAR)</text>
    <text x="580" y="460" class="field-text">is_active (BOOLEAN)</text>
    <text x="580" y="475" class="field-text">is_primary (BOOLEAN)</text>
    <text x="580" y="490" class="field-text">tenant_id (UUID)</text>
  </g>

  <!-- Relationships -->

  <!-- Auth Tokens Self-Reference -->
  <path d="M 150 240 Q 150 270 180 270 Q 210 270 210 240 Q 210 210 180 210 Q 150 210 150 240" class="relationship-line"/>
  <polygon points="150,235 145,240 150,245" class="relationship-arrow"/>
  <text x="180" y="285" text-anchor="middle" class="field-text" font-size="10">parent_token_id</text>

  <!-- Encryption Keys to Auth Tokens (created_by) -->
  <line x1="300" y1="205" x2="250" y2="150" class="relationship-line"/>
  <polygon points="250,150 245,145 255,145" class="relationship-arrow"/>
  <text x="275" y="175" text-anchor="middle" class="field-text" font-size="10">created_by</text>

  <!-- Encryption Keys to Auth Tokens (rotated_by) -->
  <line x1="300" y1="220" x2="250" y2="165" class="relationship-line"/>
  <polygon points="250,165 245,160 255,160" class="relationship-arrow"/>
  <text x="275" y="195" text-anchor="middle" class="field-text" font-size="10">rotated_by</text>

  <!-- Encryption Keys to Key Rotation Policies -->
  <line x1="520" y1="235" x2="570" y2="140" class="relationship-line"/>
  <polygon points="570,140 565,135 575,135" class="relationship-arrow"/>
  <text x="545" y="185" text-anchor="middle" class="field-text" font-size="10">rotation_policy</text>

  <!-- Encryption Keys Self-Reference -->
  <path d="M 410 260 Q 410 290 440 290 Q 470 290 470 260 Q 470 230 440 230 Q 410 230 410 260" class="relationship-line"/>
  <polygon points="410,255 405,260 410,265" class="relationship-arrow"/>
  <text x="440" y="305" text-anchor="middle" class="field-text" font-size="10">parent_key_id</text>

  <!-- Practice Profiles to Locations -->
  <line x1="520" y1="355" x2="570" y2="355" class="relationship-line"/>
  <polygon points="570,355 565,350 565,360" class="relationship-arrow"/>
  <text x="545" y="350" text-anchor="middle" class="field-text" font-size="10">1:N</text>

  <!-- Legend -->
  <g id="legend">
    <rect x="850" y="60" width="300" height="200" fill="#f8f9fa" stroke="#343a40" stroke-width="1"/>
    <text x="1000" y="80" text-anchor="middle" class="table-title">Legend</text>

    <rect x="860" y="100" width="15" height="15" class="table-header"/>
    <text x="885" y="112" class="field-text">Table Header</text>

    <text x="860" y="135" class="field-text pk-field">Primary Key (PK)</text>
    <text x="860" y="150" class="field-text fk-field">Foreign Key (FK)</text>
    <text x="860" y="165" class="field-text">Regular Field</text>

    <line x1="860" y1="180" x2="890" y2="180" class="relationship-line"/>
    <polygon points="890,180 885,175 885,185" class="relationship-arrow"/>
    <text x="900" y="185" class="field-text">Relationship</text>

    <text x="860" y="210" class="field-text" font-size="10">Self-referential relationships shown as curves</text>
    <text x="860" y="225" class="field-text" font-size="10">1:N = One-to-Many relationship</text>
    <text x="860" y="240" class="field-text" font-size="10">All tables include tenant_id for multi-tenancy</text>
  </g>

  <!-- Key Features Box -->
  <g id="features">
    <rect x="850" y="300" width="300" height="180" fill="#e9ecef" stroke="#343a40" stroke-width="1"/>
    <text x="1000" y="320" text-anchor="middle" class="table-title">Key Features</text>

    <text x="860" y="340" class="field-text">✅ Complete referential integrity</text>
    <text x="860" y="355" class="field-text">✅ Optimized indexing strategy</text>
    <text x="860" y="370" class="field-text">✅ HIPAA compliance (tenant isolation)</text>
    <text x="860" y="385" class="field-text">✅ Audit trail support</text>
    <text x="860" y="400" class="field-text">✅ Token rotation chains</text>
    <text x="860" y="415" class="field-text">✅ Key versioning & rotation</text>
    <text x="860" y="430" class="field-text">✅ FHIR integration mapping</text>
    <text x="860" y="445" class="field-text">✅ Geographic location support</text>
    <text x="860" y="460" class="field-text">✅ Check constraints for data quality</text>
  </g>

  <!-- Footer -->
  <text x="600" y="780" text-anchor="middle" class="field-text" font-size="12">Generated: January 6, 2025 | Version: 2.0 - Post Schema Cleanup & Index Audit</text>
</svg>
